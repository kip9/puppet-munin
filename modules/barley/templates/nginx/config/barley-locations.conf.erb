### FILE MANAGED BY PUPPET ###
    # Trailing Slashes
    rewrite ^/(.*)/$ /$1 permanent;

    # Remove trailing index from any URL
    rewrite ^/(.*?)index$ /$1 permanent;

    # Remove access to template folders from http
    location ~* ^/(_shell|_configs|_cache|_base_templates|_default_data|_logs|_updated_templates) {
        deny all;
    }

    # dot files
    location ~ /\. {
        access_log       off;
        log_not_found    off;
        deny             all;
    }

    # Protect other files from being read
    location ~ (~|#|\.save|\.swp|\.swo|\.tmp|\.cache|\.sql|\.session)$ {
        access_log       off;
        log_not_found    off;
        deny             all;
    }

    # Protect the system & application folder
    location ~* ^/(system|application) {
        rewrite ^/(.*)$ / permanent;
    }

    # wp-content
    location ~* ^/(wp-content) {
        rewrite ^(.*)$ http://static.public.staging.getbarley.com/$cookie_GracieLaw$1 permanent;
    }

    # HTML Files, redirect to correct page
    location ~* ^/(.*)\.(html|htm)(\?.*)?$ {
        rewrite ^/(.*)\.(html|htm)(\?.*)?$ /$1$3 permanent;
    }  

    # PHP files, redirect all but index
    location ~* ^/(.*[^index])\.php(\?.*)?$ {
        rewrite ^/(.*[^index])\.php(\?.*)?$ /$1$2 permanent;
    }

    # Barley Static Files
    location ~* ^/barley/(.*\.(.*[^php])(\?.*)?)$ {
        access_log        off;
        log_not_found     off;
        expires           max;
        try_files $uri $uri/ /public/shared/$1 =404;
    }

    # File Folders, CSS and JS for custom templates
    location ~* .*\.(.*[^php])(\?.*)?$ {
      	access_log        off;
        log_not_found     off;
        expires           max;        
	      try_files $uri $uri/ /public/templates/$cookie_lopan$uri /public/templates/$cookie_eggshen$uri =404;
    }

    location ~* ^/apps.*?sync {
        add_header X-APP sync;
        send_timeout 600;
        client_body_timeout 600;
        fastcgi_read_timeout 600;
        fastcgi_send_timeout 600;
        fastcgi_index                    index.php;
        fastcgi_pass                     127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME    $document_root/index.php;
        fastcgi_param SCRIPT_NAME        /index.php;
    }

    # Static Files
    location ~* \.(ico|css|js|gif|jpe?g|png|svg|eot|ttf|woff)(\?[0-9]+)?$ {
        access_log        off;
        log_not_found     off;
        expires           max;
    }

    # Index
    location / {
        try_files $uri $uri/ /index.php;
    }

    # PHP Processed
    location ~ \.php$ {
        fastcgi_index                    index.php;
        fastcgi_pass                     127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME    $document_root$fastcgi_script_name;
        fastcgi_param SCRIPT_NAME        $fastcgi_script_name;
    }

    # robots.txt
    location ~* ^/robots.txt {
        access_log        off;
        log_not_found     off;
      	try_files /public/templates/$template/robots.txt /robots.txt =404;    
    }

    # settings.json
    location ~* ^/settings.json {
        access_log        off;
        log_not_found     off;
        try_files /public/templates/$template/settings.json =404;
    }

